var fs = require('fs')
var http = require('http')
var test = require('../wrapper')(__dirname)
var touch = require('touch')


test('server process responds to requests', function (t) {
  t.plan(2)
  http.get({port: 1028}, function (res) {
    t.equal(res.statusCode, 200, '200 on response')
    res.on('data', function (data) {
      t.equal(data.toString(), 'ok', 'ok on response')
    })
  })
})

test('modification of node_modules file does not restart process', function (t) {
  t.plan(1)
  fs.writeFileSync(__dirname + '/node_modules/res.js', 'module.exports = function (res) {\n  res.end(\'okay\')\n}')
  setTimeout(function () {
    http.get({port: 1028}, function (res) {
      res.on('data', function (data) {
        t.equal(data.toString(), 'ok', 'ok on response')
      })
    })
  }, 500)
})

test('touching server file reloads child process', function (t) {
  t.plan(1)
  // Pause to avoid socket hangups
  setTimeout(function () {
    touch.sync(__dirname + '/server.js')
  }, 1000)
  test.server.once('online', function () {
    http.get({port: 1028}, function (res) {
      res.on('data', function (data) {
        t.equal(data.toString(), 'okay', 'okay on response')
      })
    })
  })
})

test('return file to original state', function (t) {
  t.plan(1)
  // Pause longer than watch interval before writing to file again
  setTimeout(function () {
    fs.writeFileSync(__dirname + '/node_modules/res.js', 'module.exports = function (res) {\n  res.end(\'ok\')\n}')
    touch.sync(__dirname + '/server.js')
  }, 1000)
  test.server.once('online', function () {
    http.get({port: 1028}, function (res) {
      res.on('data', function (data) {
        t.equal(data.toString(), 'ok', 'ok on response')
      })
    })
  })
})
